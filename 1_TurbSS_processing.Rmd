---
title: "TurbSS Processing"
author: "John Kemper"
date: "10/17/2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


library(googledrive)
library(tidyverse)
library(ggplot2)
library(lubridate)
library(xts)
library(ggthemes)
library(readxl)
library(tools)
library(fs)
library(stringr)
library(purrr)
library(raster)
library(dygraphs)

```


##Data download from Google Drive
```{r}
###Specify the drive using the drive URL
turb_drive <- drive_get("https://drive.google.com/drive/u/1/folders/13K-gaXcBkCkLl1TTBw2tVQCjwsAUvSIW/")

###List files on drive
files <- drive_ls(turb_drive)

###Extract only the data files
excelFiles <- files %>%
  filter(str_detect(name, ".xlsx")) 

###Function to download the files from Drive and put them in a data folder
turb_download <- function(x, y) {
  drive_download(as_id(x), overwrite = TRUE)
  
  file_move(y, "C:/Users/jkemper/Documents/UrbanSediment/DRSediment/data")
  
  
}


###Download and store the files
map2(excelFiles$id, excelFiles$name, turb_download)






```


###Get file parameters from file folders
```{r}

###Get data file names
turb_files <- list.files("data")


#file.remove("data/~$DR4.xlsx")

###Get station names
turb_file_names <- turb_files %>% str_split(., "\\.") %>%
  unlist() %>%
  str_subset(., "DR")

###Extract all sheets
#sheets <- excel_sheets(paste0("./data/", turb_files[2])) %>%
  #str_extract("201.$") %>%
  #.[!is.na(.)]


```


```{r}
##File manipulation


for(i in 1:length(turb_files)) {
  
  sheet_extractor <- function(strng){
    
  sheets <- excel_sheets(paste0("./data/", strng)) %>%
    str_extract("201.$") %>%
    .[!is.na(.)]
  
  print(sheets)
  

  }
  
  file_name_extractor <- function(srg) {
    
    turb_file_names <- srg %>% str_split(., "\\.") %>%
      unlist() %>%
      str_subset(., "DR")
    
  }
  
  print(turb_files[i])
  
  sheets <- sheet_extractor(turb_files[i])
  
  file_name_extractor(turb_files[i])
  
  tmp <- map(sheets, read_xlsx, path = (paste0("./data/", turb_files[i]))) %>%
    bind_rows() %>%
    as_tibble() %>%
    dplyr::select(1:17)
    
  
  write_csv(tmp, paste0("data/", turb_file_names[i], "_allyears.csv"))
  
}


```



###Select storms
```{r}
setwd("C:/Users/John/Documents/DR Sediment/DRSediment/data")

DR5 <- read_csv("DR5_allyears.csv") %>%  
  rename_all(~str_replace_all(., " ", "_")) %>%
  rename_all(~str_remove_all(., "[\\( \\)<>-]")) %>%
  rename_all(~str_remove_all(., "__"))
  
  
DR5_turb_test <- DR5 %>%
  dplyr::select(1:7) %>%
  filter(!is.na(datetime)) %>%
  slice(1:10000) %>%
  rename(Discharge_LperS = 3)



DR5_plot <- DR5_turb_test %>%
  xts(., select(-datetime),
      order.by = .$datetime) %>%
  dygraph(.)

storm_selector <- function(df) {
  
  if(lead(df$Discharge_LperS)*10 > df$Discharge_LperS){
    
    start_Q <- (df$Discharge_LperS)
    storm_start <- slice()
    
  } else{}
}
  
      
      
        
  
  
  
        
    
for(i in 1:500) {
  
  storm_selector(DR5_turb_test)
}

DR5_turb_test$`Discharge_L/s`

```

